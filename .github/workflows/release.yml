name: Release

on:
    release:
        types: [published]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Resolve package version from release tag
              run: |
                  VERSION="${GITHUB_REF_NAME#v}"
                  if [ -z "$VERSION" ] || echo "$VERSION" | grep -Eq '(\.dev|[+])'; then
                      echo "Invalid release tag for PyPI: ${GITHUB_REF_NAME}" >&2
                      exit 1
                  fi
                  echo "SETUPTOOLS_SCM_PRETEND_VERSION=${VERSION}" >> "$GITHUB_ENV"
                  echo "Release tag: ${GITHUB_REF_NAME}"
                  echo "Package version: ${VERSION}"

            - name: Install build dependencies
              run: |
                  python3 -m pip install --upgrade pip
                  pip install build twine

            - name: Build package
              run: |
                  python3 -m build

            - name: Check package
              run: |
                  twine check dist/*

            - name: Enforce release artifact version policy
              run: |
                  if ls dist/* | grep -Eq '(\.dev|[+])'; then
                      echo "Refusing upload: dist contains dev/local versions." >&2
                      ls -1 dist
                      exit 1
                  fi

            - name: Publish to PyPI
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
              run: |
                  twine upload --skip-existing dist/*
